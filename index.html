<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharmacie Rahmane Â· ThiÃ¨s</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --g1: #064E3B; --g2: #065F46; --g3: #047857;
  --gold: #D97706; --gold2: #F59E0B; --gold3: #FEF3C7;
  --bg: #F9F7F4; --white: #FFFFFF;
  --border: #E5E0D8; --text: #1C1917; --muted: #78716C;
  --r: 12px; --rs: 8px;
  --shadow: 0 1px 4px rgba(0,0,0,.06), 0 4px 16px rgba(0,0,0,.08);
  --shadowM: 0 8px 32px rgba(0,0,0,.12);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #D1CCC4; border-radius: 4px; }

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen {
  position: fixed; inset: 0; z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, #022C22 0%, #064E3B 50%, #065F46 100%);
}
#loginScreen::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(ellipse 70% 70% at 80% 20%, rgba(217,119,6,.12) 0%, transparent 60%),
              repeating-linear-gradient(45deg, rgba(255,255,255,.015) 0px, rgba(255,255,255,.015) 1px, transparent 1px, transparent 24px);
}
.lcard {
  position: relative; z-index: 1;
  background: rgba(255,255,255,.06); backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,.12); border-radius: 20px;
  width: 420px; max-width: 94vw; overflow: hidden;
  box-shadow: 0 32px 80px rgba(0,0,0,.5);
  animation: lreveal .7s cubic-bezier(.22,.68,0,1.2) both;
}
@keyframes lreveal { from { opacity:0; transform: translateY(28px) scale(.97); } to { opacity:1; transform: none; } }
.lhead {
  padding: 40px 40px 28px; text-align: center;
  background: linear-gradient(180deg, rgba(217,119,6,.1) 0%, transparent 100%);
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.llogo {
  width: 72px; height: 72px; border-radius: 18px; margin: 0 auto 16px;
  background: linear-gradient(135deg, rgba(217,119,6,.25), rgba(6,95,70,.3));
  border: 1px solid rgba(217,119,6,.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; box-shadow: 0 8px 24px rgba(0,0,0,.3);
  overflow: hidden;
}
.llogo img { width: 100%; height: 100%; object-fit: contain; border-radius: 14px; display: none; }
.lhead h1 { font-family: 'Playfair Display', serif; color: #fff; font-size: 1.75rem; font-weight: 700; line-height: 1.2; }
.lhead p { color: rgba(245,158,11,.8); font-size: .72rem; margin-top: 6px; letter-spacing: .12em; text-transform: uppercase; }
.lbody { padding: 28px 40px 36px; }
.lfield { margin-bottom: 16px; }
.lfield label { display: block; color: rgba(255,255,255,.45); font-size: .7rem; font-weight: 600; letter-spacing: .1em; text-transform: uppercase; margin-bottom: 7px; }
.lfield input {
  width: 100%; padding: 13px 16px;
  background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.1);
  border-radius: var(--rs); color: #fff; font-family: 'DM Sans', sans-serif; font-size: .9rem; outline: none; transition: all .2s;
}
.lfield input::placeholder { color: rgba(255,255,255,.2); }
.lfield input:focus { background: rgba(255,255,255,.1); border-color: var(--gold2); box-shadow: 0 0 0 3px rgba(245,158,11,.15); }
.lbtn {
  width: 100%; padding: 15px; border: none; border-radius: var(--rs);
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  color: #064E3B; font-family: 'DM Sans', sans-serif; font-size: .95rem; font-weight: 700;
  cursor: pointer; margin-top: 4px; transition: all .2s;
  box-shadow: 0 4px 20px rgba(217,119,6,.4);
}
.lbtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(217,119,6,.5); }
.lbtn:disabled { opacity: .5; cursor: not-allowed; }
.lerr { background: rgba(239,68,68,.15); border: 1px solid rgba(239,68,68,.25); color: #FCA5A5; padding: 9px 13px; border-radius: var(--rs); font-size: .8rem; margin-top: 10px; display: none; }

/* â”€â”€ APP LAYOUT â”€â”€ */
#app { display: none; }
.sidebar {
  position: fixed; left: 0; top: 0; bottom: 0; width: 260px;
  background: linear-gradient(180deg, var(--g1) 0%, #022C22 100%);
  display: flex; flex-direction: column; z-index: 200; overflow-y: auto;
  box-shadow: 2px 0 20px rgba(0,0,0,.15);
}
.sidebar::before {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background: repeating-linear-gradient(-45deg, rgba(255,255,255,.01) 0px, rgba(255,255,255,.01) 1px, transparent 1px, transparent 18px);
}
.sbrand {
  padding: 24px 20px 18px; border-bottom: 1px solid rgba(255,255,255,.07);
  display: flex; align-items: center; gap: 12px; position: relative;
}
.sbrand-logo {
  width: 44px; height: 44px; border-radius: 12px; flex-shrink: 0;
  background: linear-gradient(135deg, rgba(217,119,6,.2), rgba(4,120,87,.2));
  border: 1px solid rgba(217,119,6,.2);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; overflow: hidden;
}
.sbrand-logo img { width: 100%; height: 100%; object-fit: contain; display: none; }
.sbrand h2 { font-family: 'Playfair Display', serif; color: #fff; font-size: .95rem; font-weight: 600; line-height: 1.2; }
.sbrand p { color: rgba(167,243,208,.5); font-size: .65rem; margin-top: 2px; }
.sconn {
  margin: 10px 14px; padding: 6px 12px; border-radius: 99px;
  display: flex; align-items: center; gap: 6px; font-size: .7rem; font-weight: 600;
  background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.07);
}
.sconn.ok { color: #6EE7B7; } .sconn.ko { color: #FCA5A5; }
.sconn-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.sconn.ok .sconn-dot { background: #10B981; animation: pulse 2s infinite; }
.sconn.ko .sconn-dot { background: #EF4444; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.4);} 50%{box-shadow:0 0 0 5px rgba(16,185,129,0);} }
.suser {
  margin: 0 12px 10px; padding: 12px;
  background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--rs); display: flex; align-items: center; gap: 10px;
}
.suser-av {
  width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Playfair Display', serif; font-weight: 700; font-size: .95rem; color: var(--g1);
}
.suser-name { color: #fff; font-size: .82rem; font-weight: 600; }
.suser-role { color: rgba(167,243,208,.5); font-size: .67rem; }
.snav-grp { padding: 8px 10px 2px; }
.snav-lbl { color: rgba(255,255,255,.22); font-size: .62rem; font-weight: 700; letter-spacing: .14em; text-transform: uppercase; padding: 0 8px; margin-bottom: 3px; }
.snav-it {
  display: flex; align-items: center; gap: 9px;
  padding: 9px 11px; border-radius: var(--rs);
  cursor: pointer; color: rgba(255,255,255,.5); font-size: .82rem; font-weight: 500;
  transition: all .18s; margin-bottom: 1px; user-select: none; position: relative;
}
.snav-it:hover { background: rgba(255,255,255,.06); color: rgba(255,255,255,.8); }
.snav-it.active { background: rgba(255,255,255,.1); color: #fff; }
.snav-it.active::before { content: ''; position: absolute; left: 0; top: 20%; bottom: 20%; width: 3px; background: var(--gold2); border-radius: 0 3px 3px 0; }
.snav-ic { font-size: .95rem; width: 20px; text-align: center; }
.snav-badge { margin-left: auto; background: var(--gold); color: var(--g1); font-size: .6rem; font-weight: 700; padding: 2px 7px; border-radius: 99px; }
.sfoot { margin-top: auto; padding: 14px; border-top: 1px solid rgba(255,255,255,.06); }
.sfoot-btn {
  width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,.08); border-radius: var(--rs);
  background: transparent; color: rgba(255,255,255,.45); font-family: 'DM Sans', sans-serif; font-size: .8rem;
  cursor: pointer; transition: all .2s; display: flex; align-items: center; justify-content: center; gap: 7px;
}
.sfoot-btn:hover { background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.25); color: #FCA5A5; }
.main { margin-left: 260px; min-height: 100vh; }
.topbar {
  position: sticky; top: 0; z-index: 100; height: 60px;
  background: rgba(249,247,244,.93); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 28px; display: flex; align-items: center; justify-content: space-between;
}
.tb-left h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 600; }
.tb-left p { font-size: .7rem; color: var(--muted); margin-top: 1px; }
.tb-right { display: flex; align-items: center; gap: 8px; }
.tb-time { font-family: 'DM Mono', monospace; font-size: .72rem; color: var(--muted); background: #EDE9E3; padding: 5px 11px; border-radius: 99px; }
.content { padding: 24px 28px; }
.page { display: none; }
.page.active { display: block; animation: pagein .25s ease both; }
@keyframes pagein { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

/* â”€â”€ BUTTONS â”€â”€ */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border-radius: var(--rs); font-family: 'DM Sans', sans-serif; font-size: .83rem; font-weight: 600; cursor: pointer; transition: all .2s; border: none; }
.btn-p { background: linear-gradient(135deg, var(--g1), var(--g2)); color: #fff; box-shadow: 0 2px 8px rgba(6,78,59,.25); }
.btn-p:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(6,78,59,.3); }
.btn-s { background: var(--white); color: var(--text); border: 1.5px solid var(--border); }
.btn-s:hover { border-color: var(--g2); color: var(--g2); }
.btn-g { background: var(--gold3); color: var(--gold); border: 1.5px solid rgba(217,119,6,.25); }
.btn-g:hover { background: var(--gold); color: #fff; }
.btn-d { background: #FEF2F2; color: #DC2626; border: 1.5px solid rgba(220,38,38,.15); }
.btn-d:hover { background: #DC2626; color: #fff; }

/* â”€â”€ CARDS â”€â”€ */
.card { background: var(--white); border-radius: var(--r); border: 1px solid var(--border); box-shadow: var(--shadow); }
.card-h { padding: 18px 22px 0; display: flex; align-items: center; justify-content: space-between; }
.card-t { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 600; }
.card-b { padding: 16px 22px 22px; }

/* â”€â”€ KPIs â”€â”€ */
.kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-bottom: 20px; }
.kpi { background: var(--white); border-radius: var(--r); border: 1px solid var(--border); padding: 18px 20px; position: relative; overflow: hidden; box-shadow: var(--shadow); transition: all .2s; }
.kpi:hover { transform: translateY(-3px); box-shadow: var(--shadowM); }
.kpi-bar { position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: var(--r) var(--r) 0 0; }
.kpi-lbl { font-size: .68rem; font-weight: 700; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; margin-bottom: 10px; }
.kpi-val { font-family: 'DM Mono', monospace; font-size: 1.55rem; font-weight: 500; line-height: 1; }
.kpi-val small { font-size: .68rem; color: var(--muted); margin-left: 3px; font-family: 'DM Sans', sans-serif; }
.kpi-sub { font-size: .7rem; color: var(--muted); margin-top: 6px; }
.kpi-ico { position: absolute; right: 16px; top: 16px; font-size: 1.6rem; opacity: .07; }
.kpi-trend { display: inline-flex; align-items: center; gap: 3px; margin-top: 6px; font-size: .7rem; font-weight: 600; padding: 2px 7px; border-radius: 99px; }
.trend-up { color: #059669; background: rgba(5,150,105,.08); }
.trend-dn { color: #DC2626; background: rgba(220,38,38,.08); }
.trend-eq { color: var(--muted); background: #EDE9E3; }

/* â”€â”€ CHARTS â”€â”€ */
.charts-row { display: grid; grid-template-columns: 1fr 1.6fr; gap: 16px; margin-bottom: 20px; }
.chart-wrap canvas { max-height: 210px; }

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: .82rem; }
thead th { padding: 10px 14px; text-align: left; font-size: .65rem; font-weight: 700; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; background: #F4F1EC; border-bottom: 1px solid var(--border); white-space: nowrap; }
thead th:first-child { border-radius: var(--rs) 0 0 0; } thead th:last-child { border-radius: 0 var(--rs) 0 0; }
tbody td { padding: 12px 14px; border-bottom: 1px solid rgba(229,224,216,.5); vertical-align: middle; }
tbody tr:hover { background: rgba(6,78,59,.02); }
tbody tr:last-child td { border-bottom: none; }
.amt { font-family: 'DM Mono', monospace; font-weight: 500; }

/* â”€â”€ BADGES â”€â”€ */
.badge { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 99px; font-size: .68rem; font-weight: 700; white-space: nowrap; }
.bv { background: rgba(5,150,105,.1); color: #065F46; }
.bc { background: rgba(59,130,246,.1); color: #1E40AF; }
.ba { background: rgba(217,119,6,.1); color: #92400E; }
.bn { background: rgba(220,38,38,.1); color: #991B1B; }
.bg { background: #EDE9E3; color: var(--muted); }

/* â”€â”€ FILTER BAR â”€â”€ */
.fbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 14px; }
.search-box { flex: 1; min-width: 180px; display: flex; align-items: center; gap: 8px; background: var(--white); border: 1.5px solid var(--border); border-radius: var(--rs); padding: 8px 14px; transition: border-color .2s; }
.search-box:focus-within { border-color: var(--g2); box-shadow: 0 0 0 3px rgba(4,120,87,.08); }
.search-box input { border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: .85rem; flex: 1; background: transparent; }
.chips { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 14px; }
.chip { padding: 5px 12px; border-radius: 99px; font-size: .72rem; font-weight: 600; cursor: pointer; border: 1.5px solid transparent; transition: all .15s; white-space: nowrap; }
.chip-def { background: #F4F1EC; color: var(--muted); border-color: var(--border); }
.chip-def.on { background: var(--g1); color: #fff; border-color: var(--g1); }

/* â”€â”€ FORM â”€â”€ */
.fg { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.ff { display: flex; flex-direction: column; gap: 6px; }
.ff.s2 { grid-column: span 2; }
.ff label { font-size: .7rem; font-weight: 700; color: var(--muted); letter-spacing: .05em; text-transform: uppercase; }
.ff label .req { color: #DC2626; margin-left: 2px; }
.ff input, .ff select, .ff textarea {
  padding: 11px 14px; border: 1.5px solid var(--border); border-radius: var(--rs);
  font-family: 'DM Sans', sans-serif; font-size: .88rem; color: var(--text);
  background: var(--white); outline: none; transition: all .2s; appearance: none;
}
.ff select { background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%2378716C' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
.ff input:focus, .ff select:focus, .ff textarea:focus { border-color: var(--g2); box-shadow: 0 0 0 3px rgba(4,120,87,.08); }
.ff textarea { resize: vertical; min-height: 72px; line-height: 1.6; }
.f-actions { display: flex; gap: 8px; margin-top: 6px; padding-top: 16px; border-top: 1px solid var(--border); }

/* â”€â”€ MODAL â”€â”€ */
.modal-bg { position: fixed; inset: 0; background: rgba(2,44,34,.45); backdrop-filter: blur(8px); z-index: 500; display: none; align-items: center; justify-content: center; padding: 16px; }
.modal-bg.open { display: flex; animation: fadein .2s ease; }
@keyframes fadein { from{opacity:0;} to{opacity:1;} }
.modal { background: var(--white); border-radius: var(--r); width: 100%; max-width: 580px; max-height: 92vh; overflow-y: auto; box-shadow: 0 24px 80px rgba(0,0,0,.2); animation: modalin .28s cubic-bezier(.22,.68,0,1.2) both; }
@keyframes modalin { from{opacity:0;transform:translateY(16px) scale(.97);} to{opacity:1;transform:none;} }
.modal-h { padding: 22px 24px 0; display: flex; align-items: center; justify-content: space-between; }
.modal-h h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 600; }
.modal-x { background: #F4F1EC; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: .9rem; color: var(--muted); transition: all .2s; display: flex; align-items: center; justify-content: center; }
.modal-x:hover { background: #EDE9E3; color: var(--text); }
.modal-b { padding: 18px 24px 24px; }

/* â”€â”€ TYPES GRID â”€â”€ */
.types-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 10px; }
.type-card { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--white); border: 1.5px solid var(--border); border-radius: var(--rs); box-shadow: var(--shadow); transition: all .18s; }
.type-card:hover { box-shadow: var(--shadowM); transform: translateY(-1px); }
.type-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
.type-name { flex: 1; font-size: .85rem; font-weight: 600; }
.type-cnt { font-size: .7rem; color: var(--muted); }

/* â”€â”€ USERS â”€â”€ */
.users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap: 14px; }
.ucard { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--r); padding: 18px 20px; box-shadow: var(--shadow); transition: all .2s; }
.ucard:hover { box-shadow: var(--shadowM); transform: translateY(-2px); }
.ucard-av { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; flex-shrink: 0; }
.ucard-name { font-weight: 700; font-size: .9rem; }
.ucard-login { font-family: 'DM Mono', monospace; font-size: .72rem; color: var(--muted); }

/* â”€â”€ JOURNAL â”€â”€ */
.log-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
.log-item:last-child { border-bottom: none; }
.log-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
.log-txt { flex: 1; }
.log-action { font-size: .83rem; font-weight: 600; }
.log-detail { font-size: .76rem; color: var(--muted); margin-top: 2px; }
.log-ts { font-family: 'DM Mono', monospace; font-size: .68rem; color: var(--muted); white-space: nowrap; }

/* â”€â”€ LOGO ZONE â”€â”€ */
.logo-zone { border: 2px dashed var(--border); border-radius: var(--r); padding: 36px; text-align: center; cursor: pointer; transition: all .2s; background: #F9F7F4; }
.logo-zone:hover { border-color: var(--g2); background: rgba(4,120,87,.02); }

/* â”€â”€ SYNC ROW â”€â”€ */
.sync-row { display: flex; align-items: center; gap: 7px; font-size: .72rem; color: var(--muted); margin-bottom: 16px; }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #10B981; animation: pulse 2s infinite; }

/* â”€â”€ TOAST â”€â”€ */
.toast-wrap { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast { padding: 12px 18px; border-radius: var(--rs); font-size: .83rem; max-width: 320px; box-shadow: var(--shadowM); display: flex; align-items: center; gap: 9px; animation: toastin .3s cubic-bezier(.22,.68,0,1.2) both; border: 1px solid transparent; }
@keyframes toastin { from{opacity:0;transform:translateX(32px);} to{opacity:1;transform:none;} }
.toast.ok { background: #ECFDF5; color: #065F46; border-color: rgba(5,150,105,.2); }
.toast.err { background: #FEF2F2; color: #991B1B; border-color: rgba(220,38,38,.2); }
.toast.warn { background: var(--gold3); color: #92400E; border-color: rgba(217,119,6,.2); }

/* â”€â”€ SEC TITLE â”€â”€ */
.sec-title { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 18px; }
.sec-title h2 { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 600; }
.sec-title p { font-size: .78rem; color: var(--muted); margin-top: 2px; }
.divider { height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 20px 0; }

@media (max-width:900px) { .kpi-grid { grid-template-columns: 1fr 1fr; } .charts-row { grid-template-columns: 1fr; } }
@media (max-width:600px) { .sidebar { display: none; } .main { margin-left: 0; } .kpi-grid { grid-template-columns: 1fr; } }

@media print {
  #loginScreen, .sidebar, .topbar, .fbar, .chips, .btn, .modal-bg, .toast-wrap, .sync-row, #topAct { display: none !important; }
  .main { margin-left: 0 !important; } .content { padding: 0 !important; }
  .page { display: block !important; } body { background: white; }
  .card, .kpi { box-shadow: none; border: 1px solid #ddd; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="lcard">
    <div class="lhead">
      <div class="llogo" id="lLogoWrap"><img id="lLogoImg" alt=""><span id="lLogoEmoji">â˜ªï¸</span></div>
      <h1>Pharmacie Rahmane</h1>
      <p>ThiÃ¨s Â· SÃ©nÃ©gal Â· Gestion</p>
    </div>
    <div class="lbody">
      <div class="lfield"><label>Identifiant</label><input type="text" id="loginIn" placeholder="Votre identifiant" autocomplete="username"></div>
      <div class="lfield"><label>Mot de passe</label><input type="password" id="pwdIn" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
      <button class="lbtn" id="lBtn" onclick="doLogin()">Se connecter â†’</button>
      <div class="lerr" id="lErr"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <aside class="sidebar">
    <div class="sbrand">
      <div class="sbrand-logo" id="sbLogo"><img id="sbLogoImg" alt=""><span id="sbLogoEmoji">â˜ªï¸</span></div>
      <div><h2>Pharmacie Rahmane</h2><p>ThiÃ¨s Â· SÃ©nÃ©gal</p></div>
    </div>
    <div class="sconn ok" id="sconn"><div class="sconn-dot"></div><span id="sconnTxt">ConnectÃ©</span></div>
    <div class="suser">
      <div class="suser-av" id="sAv">A</div>
      <div><div class="suser-name" id="sName">â€”</div><div class="suser-role" id="sRole">â€”</div></div>
    </div>
    <div class="snav-grp">
      <div class="snav-lbl">Principal</div>
      <div class="snav-it active" onclick="go('dashboard')"><span class="snav-ic">ğŸ“Š</span>Tableau de bord</div>
      <div class="snav-it" onclick="go('registre')"><span class="snav-ic">ğŸ“‹</span>Registre<span class="snav-badge" id="nbBadge">0</span></div>
      <div class="snav-it" onclick="go('recap')"><span class="snav-ic">ğŸ“ˆ</span>RÃ©capitulatif</div>
    </div>
    <div class="snav-grp" id="adminNav">
      <div class="snav-lbl">Administration</div>
      <div class="snav-it" onclick="go('parametres')"><span class="snav-ic">âš™ï¸</span>ParamÃ¨tres & Logo</div>
      <div class="snav-it" onclick="go('types')"><span class="snav-ic">ğŸ·ï¸</span>Types de dÃ©penses</div>
      <div class="snav-it" onclick="go('users')"><span class="snav-ic">ğŸ‘¥</span>Utilisateurs</div>
      <div class="snav-it" onclick="go('journal')"><span class="snav-ic">ğŸ”</span>Journal</div>
    </div>
    <div class="snav-grp">
      <div class="snav-lbl">Exports</div>
      <div class="snav-it" onclick="showPDF()"><span class="snav-ic">ğŸ“„</span>Rapport PDF</div>
      <div class="snav-it" onclick="doCSV()"><span class="snav-ic">ğŸ“¤</span>Exporter CSV</div>
    </div>
    <div class="sfoot"><button class="sfoot-btn" onclick="logout()">ğŸšª DÃ©connecter</button></div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="tb-left">
        <h3 id="pgTitle">Tableau de bord</h3>
        <p id="pgSub">Vue d'ensemble</p>
      </div>
      <div class="tb-right">
        <span class="tb-time" id="tbTime">--:--</span>
        <button class="btn btn-s" onclick="showPDF()" style="font-size:.78rem;padding:7px 12px">ğŸ–¨ï¸ PDF</button>
        <button class="btn btn-p" id="topAct" onclick="openSaisie()">â• Nouvelle dÃ©pense</button>
      </div>
    </div>

    <div class="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="sync-row" id="syncRow"><div class="sync-dot"></div><span id="syncTxt">Synchronisationâ€¦</span></div>
        <div class="kpi-grid">
          <div class="kpi"><div class="kpi-bar" style="background:linear-gradient(90deg,#064E3B,#047857)"></div><div class="kpi-ico">ğŸ’°</div><div class="kpi-lbl">Total GÃ©nÃ©ral</div><div class="kpi-val" id="kTot">0<small>FCFA</small></div><div class="kpi-sub" id="kTotSub">0 opÃ©rations</div></div>
          <div class="kpi"><div class="kpi-bar" style="background:linear-gradient(90deg,#D97706,#F59E0B)"></div><div class="kpi-ico">ğŸ“…</div><div class="kpi-lbl">Ce mois</div><div class="kpi-val" id="kMois">0<small>FCFA</small></div><div class="kpi-trend trend-eq" id="kMoisTrend">0 opÃ©rations</div></div>
          <div class="kpi"><div class="kpi-bar" style="background:linear-gradient(90deg,#2563EB,#60A5FA)"></div><div class="kpi-ico">ğŸ”¢</div><div class="kpi-lbl">OpÃ©rations</div><div class="kpi-val" id="kOps">0</div><div class="kpi-sub">Toutes pÃ©riodes</div></div>
          <div class="kpi"><div class="kpi-bar" style="background:linear-gradient(90deg,#7C3AED,#A78BFA)"></div><div class="kpi-ico">âš–ï¸</div><div class="kpi-lbl">Moyenne</div><div class="kpi-val" id="kMoy">0<small>FCFA</small></div><div class="kpi-sub">Par opÃ©ration</div></div>
        </div>
        <div class="charts-row">
          <div class="card chart-wrap"><div class="card-h"><span class="card-t">RÃ©partition</span></div><div class="card-b"><canvas id="cPie"></canvas></div></div>
          <div class="card chart-wrap"><div class="card-h"><span class="card-t">Ã‰volution mensuelle</span><span style="font-size:.7rem;color:var(--muted)">12 mois</span></div><div class="card-b"><canvas id="cBar"></canvas></div></div>
        </div>
        <div class="card chart-wrap" style="margin-bottom:20px">
          <div class="card-h">
            <span class="card-t">ğŸ“… DÃ©penses du mois en cours</span>
            <span id="cMonthLbl" style="font-size:.7rem;color:var(--muted)"></span>
          </div>
          <div class="card-b"><canvas id="cMonth" style="max-height:180px"></canvas></div>
        </div>
        <div class="card">
          <div class="card-h"><span class="card-t">DerniÃ¨res opÃ©rations</span><button class="btn btn-s" onclick="go('registre')" style="font-size:.76rem;padding:6px 11px">Voir tout â†’</button></div>
          <div class="card-b" style="padding-top:12px"><div class="tbl-wrap"><table><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>BÃ©nÃ©ficiaire</th><th>Montant</th><th>Statut</th></tr></thead><tbody id="tbRecent"></tbody></table></div></div>
        </div>
      </div>

      <!-- REGISTRE -->
      <div class="page" id="page-registre">
        <div class="fbar">
          <div class="search-box"><span style="color:var(--muted)">ğŸ”</span><input type="text" id="searchIn" placeholder="Rechercherâ€¦" oninput="renderReg()"></div>
          <div style="display:flex;align-items:center;gap:5px;flex-shrink:0">
            <span style="font-size:.73rem;color:var(--muted)">Du</span>
            <input type="date" id="fDu" onchange="renderReg()" style="padding:7px 10px;border:1.5px solid var(--border);border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:.8rem;outline:none;background:var(--white)">
            <span style="font-size:.73rem;color:var(--muted)">au</span>
            <input type="date" id="fAu" onchange="renderReg()" style="padding:7px 10px;border:1.5px solid var(--border);border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:.8rem;outline:none;background:var(--white)">
          </div>
          <button class="btn btn-s" onclick="reinit()" style="font-size:.8rem;padding:7px 12px">âœ– Tout</button>
        </div>
        <div class="chips" id="typeChips"></div>
        <div class="card">
          <div class="card-h">
            <div><span class="card-t">Registre</span><div style="font-size:.7rem;color:var(--muted);margin-top:2px" id="regCnt">0 opÃ©ration(s)</div></div>
            <div style="display:flex;gap:7px">
              <button class="btn btn-s" onclick="doCSV()" style="font-size:.78rem;padding:7px 11px">ğŸ“¤ CSV</button>
              <button class="btn btn-p" id="btnAddReg" onclick="openSaisie()">â• Ajouter</button>
            </div>
          </div>
          <div class="card-b" style="padding-top:12px"><div class="tbl-wrap"><table><thead><tr><th>NÂ°</th><th>Date</th><th>Type</th><th>Description</th><th>BÃ©nÃ©ficiaire</th><th>RÃ©f.</th><th>Montant</th><th>Statut</th><th></th></tr></thead><tbody id="tbReg"></tbody></table></div></div>
        </div>
      </div>

      <!-- RECAP -->
      <div class="page" id="page-recap">
        <div class="card">
          <div class="card-h"><span class="card-t">RÃ©capitulatif par type</span><span id="recapTot" style="font-size:.78rem;color:var(--muted)"></span></div>
          <div class="card-b"><div class="tbl-wrap"><table><thead><tr><th>Type</th><th>OpÃ©rations</th><th>Total FCFA</th><th>Part</th><th>Moyenne</th></tr></thead><tbody id="tbRecap"></tbody></table></div></div>
        </div>
      </div>

      <!-- PARAMÃˆTRES -->
      <div class="page" id="page-parametres">
        <div class="sec-title"><div><h2>ParamÃ¨tres & Logo</h2><p>IdentitÃ© visuelle de votre pharmacie</p></div></div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-h"><span class="card-t">ğŸ–¼ï¸ Logo</span></div>
          <div class="card-b">
            <div class="logo-zone" id="logoZone" onclick="document.getElementById('logoFile').click()">
              <img id="logoPrev" style="max-width:160px;max-height:100px;border-radius:var(--rs);margin:0 auto 12px;display:none;box-shadow:var(--shadowM)" alt="">
              <div id="logoPlaceholder"><div style="font-size:2rem;margin-bottom:8px">ğŸ–¼ï¸</div><p style="font-size:.85rem;font-weight:600">Cliquer ou glisser le logo</p><p style="font-size:.74rem;color:var(--muted);margin-top:3px">PNG, JPG, SVG Â· Max 2 MB</p></div>
            </div>
            <input type="file" id="logoFile" accept="image/*" style="display:none" onchange="loadLogo(event)">
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn btn-p" onclick="document.getElementById('logoFile').click()">ğŸ“ Choisir</button>
              <button class="btn btn-d" id="btnDelLogo" onclick="delLogo()" style="display:none">ğŸ—‘ï¸ Supprimer</button>
            </div>
          </div>
        </div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-h"><span class="card-t">ğŸ¥ Informations</span></div>
          <div class="card-b">
            <div class="fg">
              <div class="ff"><label>Nom</label><input type="text" id="pNom" value="Pharmacie Rahmane"></div>
              <div class="ff"><label>Ville</label><input type="text" id="pVille" value="ThiÃ¨s, SÃ©nÃ©gal"></div>
              <div class="ff"><label>Email</label><input type="email" id="pEmail" value="rahmanepharmacie@gmail.com"></div>
              <div class="ff"><label>TÃ©lÃ©phone</label><input type="tel" id="pTel"></div>
              <div class="ff"><label>PropriÃ©taire</label><input type="text" id="pProp" value="Dr. Khady Diene"></div>
              <div class="ff"><label>NÂ° Licence</label><input type="text" id="pLic"></div>
            </div>
            <div class="f-actions"><button class="btn btn-p" onclick="saveParams()">ğŸ’¾ Enregistrer</button></div>
          </div>
        </div>
        <div class="card">
          <div class="card-h"><span class="card-t">ğŸ”‘ Changer mot de passe</span></div>
          <div class="card-b">
            <div class="fg" style="max-width:440px">
              <div class="ff"><label>Ancien</label><input type="password" id="pwdOld"></div>
              <div class="ff"><label>Nouveau</label><input type="password" id="pwdNew"></div>
              <div class="ff"><label>Confirmer</label><input type="password" id="pwdConf"></div>
            </div>
            <div class="f-actions"><button class="btn btn-p" onclick="changePwd()">ğŸ”’ Mettre Ã  jour</button></div>
          </div>
        </div>
      </div>

      <!-- TYPES -->
      <div class="page" id="page-types">
        <div class="sec-title"><div><h2>Types de dÃ©penses</h2><p>CatÃ©gories personnalisÃ©es</p></div><button class="btn btn-p" onclick="openModalType()">â• Nouveau type</button></div>
        <div class="types-grid" id="typesGrid"></div>
      </div>

      <!-- USERS -->
      <div class="page" id="page-users">
        <div class="sec-title"><div><h2>Utilisateurs</h2><p>Gestion des accÃ¨s</p></div><button class="btn btn-p" onclick="openModalUser()">â• Nouvel utilisateur</button></div>
        <div class="users-grid" id="usersGrid"></div>
      </div>

      <!-- JOURNAL -->
      <div class="page" id="page-journal">
        <div class="sec-title"><div><h2>Journal d'accÃ¨s</h2><p>TraÃ§abilitÃ© complÃ¨te</p></div><button class="btn btn-d" onclick="clearLog()">ğŸ—‘ï¸ Vider</button></div>
        <div class="card"><div class="card-b" id="logList"></div></div>
      </div>

    </div>
  </main>
</div>

<!-- MODAL SAISIE -->
<div class="modal-bg" id="mSaisie">
  <div class="modal">
    <div class="modal-h"><h3 id="mSaisieTtl">â• Nouvelle dÃ©pense</h3><button class="modal-x" onclick="closeModal('mSaisie')">âœ•</button></div>
    <div class="modal-b">
      <div class="fg">
        <div class="ff"><label>Date <span class="req">*</span></label><input type="date" id="fDate"></div>
        <div class="ff"><label>Type <span class="req">*</span></label><select id="fType"><option value="">-- Choisir --</option></select></div>
        <div class="ff s2"><label>Description <span class="req">*</span></label><input type="text" id="fLib" placeholder="LibellÃ© de la dÃ©penseâ€¦"></div>
        <div class="ff"><label>BÃ©nÃ©ficiaire</label><input type="text" id="fBenef" placeholder="Nom du bÃ©nÃ©ficiaire"></div>
        <div class="ff"><label>Mode de paiement</label><select id="fMode"><option>Virement bancaire</option><option>EspÃ¨ces</option><option>ChÃ¨que</option><option>Mobile Money</option><option>Orange Money</option><option>Wave</option></select></div>
        <div class="ff"><label>RÃ©fÃ©rence</label><input type="text" id="fRef" placeholder="Ex : VIR-2025-001"></div>
        <div class="ff"><label>Montant (FCFA) <span class="req">*</span></label><input type="number" id="fMt" placeholder="0" min="0"></div>
        <div class="ff"><label>Statut</label><select id="fStat"><option>En attente</option><option>En cours</option><option>ValidÃ©</option><option>AnnulÃ©</option><option>Litigieux</option></select></div>
        <div class="ff s2"><label>Observations</label><textarea id="fObs" placeholder="Notesâ€¦"></textarea></div>
      </div>
      <div class="f-actions">
        <button class="btn btn-p" onclick="saveDep()">ğŸ’¾ Enregistrer</button>
        <button class="btn btn-s" onclick="closeModal('mSaisie')">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL TYPE -->
<div class="modal-bg" id="mType">
  <div class="modal" style="max-width:420px">
    <div class="modal-h"><h3>ğŸ·ï¸ Nouveau type</h3><button class="modal-x" onclick="closeModal('mType')">âœ•</button></div>
    <div class="modal-b">
      <div class="ff" style="margin-bottom:14px"><label>Nom <span class="req">*</span></label><input type="text" id="tNom" placeholder="Ex : Loyer, Assuranceâ€¦" oninput="updateTypePrev()"></div>
      <div class="ff" style="margin-bottom:14px">
        <label>Couleur</label>
        <div style="display:flex;gap:7px;flex-wrap:wrap;align-items:center;margin-top:4px">
          <div data-c="#064E3B" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#064E3B;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <div data-c="#C0392B" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#C0392B;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <div data-c="#CA6F1E" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#CA6F1E;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <div data-c="#1E8449" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#1E8449;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <div data-c="#8E44AD" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#8E44AD;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <div data-c="#2E86C1" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#2E86C1;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <div data-c="#7F8C8D" onclick="pickColor(this)" style="width:30px;height:30px;border-radius:50%;background:#7F8C8D;cursor:pointer;border:3px solid transparent;transition:all .15s"></div>
          <input type="color" id="tColorPick" value="#064E3B" oninput="pickColorVal(this.value)" style="width:34px;height:30px;border:1.5px solid var(--border);border-radius:6px;padding:1px;cursor:pointer">
        </div>
        <input type="hidden" id="tColor" value="#064E3B">
      </div>
      <div class="ff" style="margin-bottom:0"><label>AperÃ§u</label>
        <div id="tPrev" style="margin-top:4px;display:inline-flex;align-items:center;gap:8px;padding:9px 14px;border-radius:var(--rs);background:#064E3B22;color:#064E3B;font-size:.83rem;font-weight:600">
          <div style="width:9px;height:9px;border-radius:50%;background:#064E3B"></div><span>Nouveau type</span>
        </div>
      </div>
      <div class="f-actions">
        <button class="btn btn-p" onclick="saveType()">âœ… CrÃ©er</button>
        <button class="btn btn-s" onclick="closeModal('mType')">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL USER -->
<div class="modal-bg" id="mUser">
  <div class="modal" style="max-width:460px">
    <div class="modal-h"><h3>ğŸ‘¤ Nouvel utilisateur</h3><button class="modal-x" onclick="closeModal('mUser')">âœ•</button></div>
    <div class="modal-b">
      <div class="fg">
        <div class="ff"><label>Identifiant <span class="req">*</span></label><input type="text" id="uLogin" placeholder="ex : amadou"></div>
        <div class="ff"><label>Mot de passe <span class="req">*</span></label><input type="password" id="uPwd" placeholder="Min. 4 caractÃ¨res"></div>
        <div class="ff"><label>Nom complet</label><input type="text" id="uNom" placeholder="PrÃ©nom Nom"></div>
        <div class="ff"><label>RÃ´le <span class="req">*</span></label><select id="uRole"><option value="Administrateur">Administrateur</option><option value="Saisie" selected>Saisie</option><option value="Lecture">Lecture</option></select></div>
        <div class="ff s2"><label>Email</label><input type="email" id="uEmail" placeholder="utilisateur@pharmacie.sn"></div>
      </div>
      <div class="f-actions">
        <button class="btn btn-p" onclick="saveUser()">âœ… CrÃ©er</button>
        <button class="btn btn-s" onclick="closeModal('mUser')">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PDF -->
<div class="modal-bg" id="mPDF">
  <div class="modal" style="max-width:460px">
    <div class="modal-h"><h3>ğŸ“„ Exporter PDF</h3><button class="modal-x" onclick="closeModal('mPDF')">âœ•</button></div>
    <div class="modal-b">
      <div style="display:grid;gap:8px">
        <button class="btn btn-s" onclick="printPage('dashboard')" style="justify-content:flex-start;gap:12px;padding:13px 16px;font-size:.85rem"><span style="font-size:1.05rem">ğŸ“Š</span><div style="text-align:left"><div style="font-weight:600">Tableau de bord</div><div style="font-size:.73rem;color:var(--muted)">KPIs + Graphiques + RÃ©cents</div></div></button>
        <button class="btn btn-s" onclick="printPage('registre')" style="justify-content:flex-start;gap:12px;padding:13px 16px;font-size:.85rem"><span style="font-size:1.05rem">ğŸ“‹</span><div style="text-align:left"><div style="font-weight:600">Registre complet</div><div style="font-size:.73rem;color:var(--muted)">Toutes les dÃ©penses filtrÃ©es</div></div></button>
        <button class="btn btn-s" onclick="printPage('recap')" style="justify-content:flex-start;gap:12px;padding:13px 16px;font-size:.85rem"><span style="font-size:1.05rem">ğŸ“ˆ</span><div style="text-align:left"><div style="font-weight:600">RÃ©capitulatif</div><div style="font-size:.73rem;color:var(--muted)">Totaux Â· parts Â· moyennes</div></div></button>
        <button class="btn btn-g" onclick="genMonthly()" style="justify-content:flex-start;gap:12px;padding:13px 16px;font-size:.85rem;margin-top:3px"><span style="font-size:1.05rem">ğŸ“‘</span><div style="text-align:left"><div style="font-weight:600">Rapport mensuel signable</div><div style="font-size:.73rem">Avec entÃªte officielle + signatures</div></div></button>
      </div>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA_URL = 'https://tmshposkrebpwhtuxfaf.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtc2hwb3NrcmVicHdodHV4ZmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDk1MDcsImV4cCI6MjA4NzI4NTUwN30.-znENe16nZTlSr3Wy40geLgsVSuLsIHAVfmG5AXsObs';
const DB_OK = SUPA_URL.startsWith('https://') && SUPA_KEY.startsWith('eyJ');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ã‰TAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  user:null, role:null, logo:null,
  dep:[], users:[], logs:[], types:[], params:{},
  editId:null, filterType:'', selColor:'#064E3B', cMonth:null,
  attempts:0, cPie:null, cBar:null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DONNÃ‰ES PAR DÃ‰FAUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEF_TYPES = [
  {id:'t1',nom:'Virement',couleur:'#1A5276',systeme:true},
  {id:'t2',nom:'CrÃ©ance',couleur:'#C0392B',systeme:true},
  {id:'t3',nom:'Frais diverses',couleur:'#CA6F1E',systeme:true},
  {id:'t4',nom:"Chiffre d'affaires",couleur:'#1E8449',systeme:true},
  {id:'t5',nom:'Fournisseurs comptants',couleur:'#9A7C09',systeme:true},
  {id:'t6',nom:'RelevÃ©e bancaire',couleur:'#7F8C8D',systeme:true},
];
const DEF_USERS = [
  {id:'u1',login:'aminata',pwd:hp('Admin@2026!'),role:'Administrateur',nom:'Dr. Aminata Nguer',email:'rahmanepharmacie@gmail.com',actif:true,derniere_connexion:null},
  {id:'u2',login:'khady',pwd:hp('Khady@2026!'),role:'Administrateur',nom:'Dr. Khady Diene',email:'rahmanepharmacie@gmail.com',actif:true,derniere_connexion:null},
  {id:'u3',login:'Compta',pwd:hp('Compta@2026'),role:'Lecture',nom:'Compta (Comptable)',email:'rahmanepharmacie@gmail.com',actif:true,derniere_connexion:null},
];
const DEF_PARAMS = {nom:'Pharmacie Rahmane',ville:'Grand Standing EDK, ThiÃ¨s, SÃ©nÃ©gal',email:'rahmanepharmacie@gmail.com',tel:'',prop:'Dr. Khady Diene',lic:''};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hp(p){let r='';for(let i=0;i<p.length;i++)r+=String(p.charCodeAt(i)^(i*7+13)).padStart(3,'0');return r;}
function fd(d){if(!d)return'â€“';const[y,m,j]=d.split('-');return`${j}/${m}/${y}`;}
function fdt(dt){const d=new Date(dt);return d.toLocaleDateString('fr-FR')+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});}
function uid(){return'id_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);}
function tc(n){const t=S.types.find(x=>x.nom===n);return t?t.couleur:'#78716C';}
const STAT_CLS={'ValidÃ©':'bv','En cours':'bc','En attente':'ba','AnnulÃ©':'bn','Litigieux':'bn'};
const ROLE_STYLE={Administrateur:{bg:'rgba(6,78,59,.08)',c:'#064E3B'},Saisie:{bg:'rgba(4,120,87,.08)',c:'#047857'},Lecture:{bg:'rgba(120,113,108,.1)',c:'#78716C'}};

function toast(m,t='ok'){
  const w=document.getElementById('toasts');
  const el=document.createElement('div');
  el.className=`toast ${t}`;
  el.innerHTML=(t==='ok'?'âœ…':t==='err'?'âŒ':'âš ï¸')+' '+m;
  w.appendChild(el);
  setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';},3000);
  setTimeout(()=>el.remove(),3400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCAL STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lsSave(){
  try{
    localStorage.setItem('pr_dep',JSON.stringify(S.dep));
    localStorage.setItem('pr_usr',JSON.stringify(S.users));
    localStorage.setItem('pr_log',JSON.stringify(S.logs.slice(0,200)));
    localStorage.setItem('pr_types',JSON.stringify(S.types));
    localStorage.setItem('pr_params',JSON.stringify(S.params));
    if(S.logo)localStorage.setItem('pr_logo',S.logo);
    else localStorage.removeItem('pr_logo');
  }catch(e){}
}
function lsLoad(){
  try{
    S.dep    = JSON.parse(localStorage.getItem('pr_dep')||'[]');
    S.users  = JSON.parse(localStorage.getItem('pr_usr')||'null') || [...DEF_USERS];
    S.logs   = JSON.parse(localStorage.getItem('pr_log')||'[]');
    S.types  = JSON.parse(localStorage.getItem('pr_types')||'null') || [...DEF_TYPES];
    S.params = JSON.parse(localStorage.getItem('pr_params')||'null') || {...DEF_PARAMS};
    S.logo   = localStorage.getItem('pr_logo')||null;
  }catch(e){S.dep=[];S.users=[...DEF_USERS];S.logs=[];S.types=[...DEF_TYPES];S.params={...DEF_PARAMS};}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE â€” REQUÃŠTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sbFetch(table, method='GET', body=null, qs=''){
  const url = `${SUPA_URL}/rest/v1/${table}${qs}`;
  const headers = {
    'apikey': SUPA_KEY,
    'Authorization': 'Bearer ' + SUPA_KEY,
    'Content-Type': 'application/json',
  };
  if(method === 'POST') headers['Prefer'] = 'return=representation';
  const res = await fetch(url, {method, headers, body: body ? JSON.stringify(body) : null});
  if(!res.ok){
    const err = await res.text();
    throw new Error(err);
  }
  if(res.status === 204) return null;
  return res.json().catch(()=>null);
}

const dbGet  = (t, qs='') => sbFetch(t, 'GET', null, qs);
const dbPost = (t, d)     => sbFetch(t, 'POST', d);
const dbPatch= (t,id,d)   => sbFetch(t, 'PATCH', d, `?id=eq.${id}`);
const dbDel  = (t,id)     => sbFetch(t, 'DELETE', null, `?id=eq.${id}`);

async function addLog(action, detail=''){
  const e={ts:new Date().toISOString(),utilisateur:S.user,role:S.role,action,detail};
  S.logs.unshift({id:uid(),...e});
  if(DB_OK) dbPost('journal',e).catch(()=>{});
  lsSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT & SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boot(){
  lsLoad();
  applyLogo();
  document.getElementById('loginScreen').style.display='flex';
}

async function syncDB(){
  if(!DB_OK){ setConn(false); return; }
  document.getElementById('syncTxt').textContent='ğŸ”„ Synchronisationâ€¦';
  try{
    // DÃ©penses
    const dep = await dbGet('depenses','?order=created_at.asc');
    if(dep && dep.length) S.dep = dep;

    // Types
    const types = await dbGet('types_depenses','?order=created_at.asc').catch(()=>null);
    if(types && types.length){
      S.types = types;
    } else if(!types || !types.length){
      for(const t of DEF_TYPES) await dbPost('types_depenses',t).catch(()=>{});
      S.types = [...DEF_TYPES];
    }

    refresh();
    document.getElementById('syncTxt').textContent='ğŸŸ¢ SynchronisÃ© Â· '+new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    setConn(true);

    // Utilisateurs et journal en arriÃ¨re-plan
    const [usr, logs] = await Promise.all([
      dbGet('utilisateurs','?order=created_at.asc').catch(()=>null),
      dbGet('journal','?order=ts.desc').catch(()=>null),
    ]);
    if(usr && usr.length) S.users = usr;
    else if(!usr || !usr.length){
      for(const u of DEF_USERS) await dbPost('utilisateurs',u).catch(()=>{});
      S.users = [...DEF_USERS];
    }
    if(logs && logs.length) S.logs = logs;
    lsSave();

  }catch(e){
    console.warn('Sync Ã©chouÃ©:', e.message);
    setConn(false);
    document.getElementById('syncTxt').textContent='ğŸ”´ Hors ligne â€” donnÃ©es locales';
  }
}

function setConn(ok){
  const el=document.getElementById('sconn');
  el.className='sconn '+(ok?'ok':'ko');
  document.getElementById('sconnTxt').textContent=ok?'ConnectÃ© Â· Temps rÃ©el':'Mode hors ligne';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin(){
  const login=document.getElementById('loginIn').value.trim();
  const pwd=document.getElementById('pwdIn').value;
  const err=document.getElementById('lErr');
  const btn=document.getElementById('lBtn');
  err.style.display='none';
  btn.disabled=true; btn.textContent='Connexionâ€¦';
  try{
    const u=S.users.find(x=>x.login.toLowerCase()===login.toLowerCase()&&x.actif!==false);
    if(u && u.pwd===hp(pwd)){
      S.user=u.login; S.role=u.role; S.attempts=0;
      u.derniere_connexion=new Date().toISOString();
      lsSave();
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('app').style.display='block';
      initApp();
      syncDB().then(()=>{
        if(DB_OK) dbPatch('utilisateurs',u.id,{derniere_connexion:u.derniere_connexion}).catch(()=>{});
        addLog('CONNEXION',`${u.login} [${u.role}]`);
      });
    } else {
      S.attempts++;
      const left=3-S.attempts;
      err.textContent=left>0?`Identifiant ou mot de passe incorrect. ${left} tentative(s).`:'AccÃ¨s bloquÃ©.';
      err.style.display='block';
      if(left<=0){['loginIn','pwdIn'].forEach(i=>document.getElementById(i).disabled=true);btn.disabled=true;}
    }
  } finally {
    if(!document.getElementById('loginIn').disabled){btn.disabled=false;btn.textContent='Se connecter â†’';}
  }
}
document.addEventListener('keydown',e=>{
  if(e.key==='Enter' && document.getElementById('loginScreen').style.display!=='none') doLogin();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  const u=S.users.find(x=>x.login===S.user);
  document.getElementById('sAv').textContent=S.user[0].toUpperCase();
  document.getElementById('sName').textContent=u?u.nom:S.user;
  document.getElementById('sRole').textContent=S.role;
  if(S.role!=='Administrateur') document.getElementById('adminNav').style.display='none';
  if(S.role==='Lecture') document.getElementById('topAct').style.display='none';
  setInterval(()=>{document.getElementById('tbTime').textContent=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});},1000);
  // Auto-refresh toutes les 30s
  if(DB_OK) setInterval(async()=>{
    try{
      const dep=await dbGet('depenses','?order=created_at.asc');
      if(dep && dep.length) S.dep=dep;
      refresh();
      document.getElementById('syncTxt').textContent='ğŸŸ¢ SynchronisÃ© Â· '+new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    }catch(e){document.getElementById('syncTxt').textContent='ğŸ”´ Hors ligne';}
  },30000);
  refresh();
  go('dashboard');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PAGES={
  dashboard:{t:'Tableau de bord',s:'Vue d\'ensemble Â· Temps rÃ©el'},
  registre:{t:'Registre des dÃ©penses',s:'Toutes les opÃ©rations'},
  recap:{t:'RÃ©capitulatif',s:'Analyse par type'},
  parametres:{t:'ParamÃ¨tres & Logo',s:'Personnalisation'},
  types:{t:'Types de dÃ©penses',s:'CatÃ©gories'},
  users:{t:'Utilisateurs',s:'Gestion des accÃ¨s'},
  journal:{t:'Journal d\'accÃ¨s',s:'Audit complet'},
};
function go(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.snav-it').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.snav-it').forEach(n=>{if((n.getAttribute('onclick')||'').includes(`'${id}'`))n.classList.add('active');});
  const m=PAGES[id]||{};
  document.getElementById('pgTitle').textContent=m.t||'';
  document.getElementById('pgSub').textContent=m.s||'';
  document.getElementById('topAct').style.display=(id==='registre'||id==='dashboard')&&S.role!=='Lecture'?'inline-flex':'none';
  if(id==='users') renderUsers();
  if(id==='journal') renderJournal();
  if(id==='recap') renderRecap();
  if(id==='registre') renderReg();
  if(id==='types') renderTypes();
  if(id==='parametres') loadParams();
  if(id==='dashboard') renderDash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash(){
  const dep=S.dep;
  const tot=dep.reduce((s,d)=>s+Number(d.montant),0);
  const nb=dep.length;
  const now=new Date();
  const mDep=dep.filter(d=>{const dd=new Date(d.date);return dd.getMonth()===now.getMonth()&&dd.getFullYear()===now.getFullYear();});
  const mTot=mDep.reduce((s,d)=>s+Number(d.montant),0);
  const prevD=new Date(now.getFullYear(),now.getMonth()-1,1);
  const prevDep=dep.filter(d=>{const dd=new Date(d.date);return dd.getMonth()===prevD.getMonth()&&dd.getFullYear()===prevD.getFullYear();});
  const prevTot=prevDep.reduce((s,d)=>s+Number(d.montant),0);
  const diff=prevTot>0?Math.round((mTot-prevTot)/prevTot*100):null;

  document.getElementById('kTot').innerHTML=`${tot.toLocaleString('fr-FR')}<small>FCFA</small>`;
  document.getElementById('kTotSub').textContent=`${nb} opÃ©ration(s)`;
  document.getElementById('kMois').innerHTML=`${mTot.toLocaleString('fr-FR')}<small>FCFA</small>`;
  const trendEl=document.getElementById('kMoisTrend');
  if(diff===null){trendEl.className='kpi-trend trend-eq';trendEl.textContent=mDep.length+' opÃ©ration(s)';}
  else if(diff>0){trendEl.className='kpi-trend trend-up';trendEl.textContent=`â†‘ +${diff}% vs mois prÃ©c.`;}
  else{trendEl.className='kpi-trend trend-dn';trendEl.textContent=`â†“ ${diff}% vs mois prÃ©c.`;}
  document.getElementById('kOps').textContent=nb;
  document.getElementById('kMoy').innerHTML=`${Math.round(nb?tot/nb:0).toLocaleString('fr-FR')}<small>FCFA</small>`;
  document.getElementById('nbBadge').textContent=nb;

  // PIE
  const tt={};
  S.types.forEach(t=>tt[t.nom]=0);
  dep.forEach(d=>{tt[d.type]=(tt[d.type]||0)+Number(d.montant);});
  const labs=Object.keys(tt).filter(k=>tt[k]>0);
  const vals=labs.map(k=>tt[k]);
  const cols=labs.map(k=>tc(k));
  if(S.cPie)S.cPie.destroy();
  S.cPie=new Chart(document.getElementById('cPie').getContext('2d'),{
    type:'doughnut',
    data:{labels:labs,datasets:[{data:vals,backgroundColor:cols.map(c=>c+'BB'),borderColor:cols,borderWidth:2,hoverOffset:5}]},
    options:{responsive:true,plugins:{legend:{position:'bottom',labels:{font:{family:'DM Sans',size:10},padding:12,usePointStyle:true}}},cutout:'60%'}
  });

  // BAR
  const bls=[],bds=[];
  for(let i=11;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    bls.push(d.toLocaleDateString('fr-FR',{month:'short',year:'2-digit'}));
    bds.push(dep.filter(x=>{const dd=new Date(x.date);return dd.getMonth()===d.getMonth()&&dd.getFullYear()===d.getFullYear();}).reduce((s,x)=>s+Number(x.montant),0));
  }
  if(S.cBar)S.cBar.destroy();
  S.cBar=new Chart(document.getElementById('cBar').getContext('2d'),{
    type:'bar',
    data:{labels:bls,datasets:[{data:bds,backgroundColor:'rgba(6,78,59,.65)',borderColor:'#064E3B',borderWidth:1,borderRadius:7,borderSkipped:false}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>v.toLocaleString('fr-FR'),font:{size:10}},grid:{color:'rgba(0,0,0,.04)'}},x:{ticks:{font:{size:10}},grid:{display:false}}}}
  });

  // GRAPHIQUE MOIS EN COURS
  const mLabel = now.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  document.getElementById('cMonthLbl').textContent = mLabel;
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const dayLabels = Array.from({length:daysInMonth},(_,i)=>String(i+1));
  const dayTotals = Array.from({length:daysInMonth},(_,i)=>{
    const day = String(i+1).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const prefix = `${now.getFullYear()}-${mm}-${day}`;
    return mDep.filter(d=>d.date===prefix).reduce((s,d)=>s+Number(d.montant),0);
  });
  const todayIdx = now.getDate()-1;
  const barColors = dayTotals.map((v,i)=> i===todayIdx ? 'rgba(217,119,6,.85)' : v>0 ? 'rgba(6,78,59,.65)' : 'rgba(6,78,59,.12)');
  if(S.cMonth) S.cMonth.destroy();
  S.cMonth = new Chart(document.getElementById('cMonth').getContext('2d'),{
    type:'bar',
    data:{
      labels:dayLabels,
      datasets:[{
        label:'FCFA',
        data:dayTotals,
        backgroundColor:barColors,
        borderColor:dayTotals.map((v,i)=>i===todayIdx?'#D97706':v>0?'#064E3B':'rgba(6,78,59,.2)'),
        borderWidth:1,
        borderRadius:5,
        borderSkipped:false,
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y.toLocaleString('fr-FR')} FCFA`}}
      },
      scales:{
        y:{ticks:{callback:v=>v>0?v.toLocaleString('fr-FR'):'',font:{size:9}},grid:{color:'rgba(0,0,0,.04)'},border:{display:false}},
        x:{ticks:{font:{size:9}},grid:{display:false}}
      }
    }
  });

  // RÃ‰CENTS
  const rec=[...dep].sort((a,b)=>(b.date||'').localeCompare(a.date||'')).slice(0,6);
  document.getElementById('tbRecent').innerHTML=rec.length===0
    ?'<tr><td colspan="6" style="text-align:center;padding:36px;color:var(--muted)">Aucune opÃ©ration</td></tr>'
    :rec.map(d=>`<tr>
      <td style="font-size:.78rem;color:var(--muted);white-space:nowrap">${fd(d.date)}</td>
      <td><span class="badge" style="background:${tc(d.type)}18;color:${tc(d.type)}">${d.type}</span></td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.82rem">${d.libelle}</td>
      <td style="font-size:.78rem;color:var(--muted)">${d.benef||'â€“'}</td>
      <td><span class="amt" style="color:var(--g1)">${Number(d.montant).toLocaleString('fr-FR')}</span> <span style="font-size:.68rem;color:var(--muted)">FCFA</span></td>
      <td><span class="badge ${STAT_CLS[d.statut]||'bg'}">${d.statut}</span></td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REGISTRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cft='';
function renderChips(){
  document.getElementById('typeChips').innerHTML=
    `<span class="chip chip-def ${!cft?'on':''}" onclick="setFT('')">Tous</span>`
    +S.types.map(t=>`<span class="chip ${cft===t.nom?'on':''}" style="background:${cft===t.nom?t.couleur:t.couleur+'15'};color:${t.couleur};border-color:${cft===t.nom?t.couleur:'transparent'}" onclick="setFT('${t.nom.replace(/'/g,"\\'")}')">â— ${t.nom}</span>`).join('');
}
function setFT(t){cft=t;renderChips();renderReg();}
function reinit(){
  document.getElementById('searchIn').value='';
  const du=document.getElementById('fDu'); if(du)du.value='';
  const au=document.getElementById('fAu'); if(au)au.value='';
  cft=''; renderChips(); renderReg();
}
function renderReg(){
  renderChips();
  const s=(document.getElementById('searchIn')?.value||'').toLowerCase();
  const du=(document.getElementById('fDu')?.value)||'';
  const au=(document.getElementById('fAu')?.value)||'';
  let dep=[...S.dep];
  if(cft) dep=dep.filter(d=>d.type===cft);
  if(s) dep=dep.filter(d=>(d.libelle||'').toLowerCase().includes(s)||(d.benef||'').toLowerCase().includes(s)||(d.ref||'').toLowerCase().includes(s)||(d.type||'').toLowerCase().includes(s));
  if(du) dep=dep.filter(d=>d.date>=du);
  if(au) dep=dep.filter(d=>d.date<=au);
  dep.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  document.getElementById('regCnt').textContent=`${dep.length} opÃ©ration(s)`;
  document.getElementById('tbReg').innerHTML=dep.length===0
    ?'<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--muted)">Aucune dÃ©pense</td></tr>'
    :dep.map((d,i)=>`<tr>
      <td class="amt" style="font-size:.7rem;color:var(--muted)">#${String(i+1).padStart(3,'0')}</td>
      <td style="font-size:.78rem;color:var(--muted);white-space:nowrap">${fd(d.date)}</td>
      <td><span class="badge" style="background:${tc(d.type)}15;color:${tc(d.type)};font-size:.66rem">${d.type}</span></td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.82rem" title="${d.libelle}">${d.libelle}</td>
      <td style="font-size:.78rem;color:var(--muted)">${d.benef||'â€“'}</td>
      <td class="amt" style="font-size:.7rem;color:var(--muted)">${d.ref||'â€“'}</td>
      <td><span class="amt" style="color:var(--g1)">${Number(d.montant).toLocaleString('fr-FR')}</span> <span style="font-size:.66rem;color:var(--muted)">FCFA</span></td>
      <td><span class="badge ${STAT_CLS[d.statut]||'bg'}">${d.statut}</span></td>
      <td>${S.role!=='Lecture'?`<div style="display:flex;gap:4px">
        <button class="btn btn-s" onclick="editDep('${d.id}')" style="padding:4px 8px;font-size:.72rem">âœï¸</button>
        <button class="btn btn-d" onclick="delDep('${d.id}')" style="padding:4px 8px;font-size:.72rem">ğŸ—‘ï¸</button>
      </div>`:'â€“'}</td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAISIE DÃ‰PENSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fillTypeSel(){
  const s=document.getElementById('fType'),v=s.value;
  s.innerHTML='<option value="">-- Choisir --</option>'+S.types.map(t=>`<option value="${t.nom}"${v===t.nom?' selected':''}>${t.nom}</option>`).join('');
}
function openSaisie(){
  if(S.role==='Lecture'){toast('Mode lecture seule','warn');return;}
  S.editId=null;
  document.getElementById('mSaisieTtl').textContent='â• Nouvelle dÃ©pense';
  document.getElementById('fDate').value=new Date().toISOString().split('T')[0];
  ['fType','fLib','fBenef','fRef','fObs'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fMt').value='';
  document.getElementById('fStat').value='En attente';
  fillTypeSel(); openModal('mSaisie');
}
function editDep(id){
  const d=S.dep.find(x=>x.id===id); if(!d)return;
  S.editId=id;
  document.getElementById('mSaisieTtl').textContent='âœï¸ Modifier';
  document.getElementById('fDate').value=d.date;
  fillTypeSel();
  document.getElementById('fType').value=d.type;
  document.getElementById('fLib').value=d.libelle;
  document.getElementById('fBenef').value=d.benef||'';
  document.getElementById('fMode').value=d.mode||'EspÃ¨ces';
  document.getElementById('fRef').value=d.ref||'';
  document.getElementById('fMt').value=d.montant;
  document.getElementById('fStat').value=d.statut;
  document.getElementById('fObs').value=d.obs||'';
  openModal('mSaisie');
}
async function saveDep(){
  const date=document.getElementById('fDate').value;
  const type=document.getElementById('fType').value;
  const libelle=document.getElementById('fLib').value.trim();
  const montant=Number(document.getElementById('fMt').value);
  if(!date||!type||!libelle||!montant){toast('Champs obligatoires manquants (*)','warn');return;}
  const data={date,type,libelle,benef:document.getElementById('fBenef').value.trim(),mode:document.getElementById('fMode').value,ref:document.getElementById('fRef').value.trim(),montant,statut:document.getElementById('fStat').value,obs:document.getElementById('fObs').value.trim(),created_by:S.user};
  try{
    if(S.editId){
      if(DB_OK) await dbPatch('depenses',S.editId,data);
      const i=S.dep.findIndex(x=>x.id===S.editId);
      if(i>-1) S.dep[i]={...S.dep[i],...data};
      addLog('MODIFICATION',`${type} â€” ${libelle} â€” ${montant} FCFA`);
      toast('DÃ©pense modifiÃ©e âœ“');
    } else {
      let newDep={id:uid(),...data};
      if(DB_OK){
        const r=await dbPost('depenses',data);
        if(r&&r[0]) newDep=r[0];
      }
      S.dep.push(newDep);
      addLog('SAISIE',`${type} â€” ${libelle} â€” ${montant} FCFA`);
      toast('DÃ©pense enregistrÃ©e âœ“');
    }
    lsSave(); closeModal('mSaisie'); refresh();
  }catch(e){toast('Erreur : '+e.message,'err');}
}
async function delDep(id){
  const d=S.dep.find(x=>x.id===id); if(!d)return;
  if(!confirm(`Supprimer ?\n${d.libelle} â€” ${Number(d.montant).toLocaleString('fr-FR')} FCFA`))return;
  try{
    if(DB_OK) await dbDel('depenses',id);
    S.dep=S.dep.filter(x=>x.id!==id);
    addLog('SUPPRESSION',`${d.type} â€” ${d.libelle}`);
    lsSave(); refresh(); toast('DÃ©pense supprimÃ©e');
  }catch(e){toast('Erreur','err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RÃ‰CAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRecap(){
  const tt={},nb={};
  S.types.forEach(t=>{tt[t.nom]=0;nb[t.nom]=0;});
  S.dep.forEach(d=>{tt[d.type]=(tt[d.type]||0)+Number(d.montant);nb[d.type]=(nb[d.type]||0)+1;});
  const gT=Object.values(tt).reduce((s,v)=>s+v,0);
  const gN=Object.values(nb).reduce((s,v)=>s+v,0);
  document.getElementById('recapTot').textContent=`${gT.toLocaleString('fr-FR')} FCFA Â· ${gN} opÃ©rations`;
  document.getElementById('tbRecap').innerHTML=S.types.map(t=>{
    const p=gT>0?(tt[t.nom]/gT*100).toFixed(1):'0.0';
    const m=nb[t.nom]>0?Math.round(tt[t.nom]/nb[t.nom]):0;
    return`<tr>
      <td><span class="badge" style="background:${t.couleur}15;color:${t.couleur}">${t.nom}</span></td>
      <td class="amt">${nb[t.nom]}</td>
      <td><span class="amt" style="color:var(--g1)">${tt[t.nom].toLocaleString('fr-FR')}</span> FCFA</td>
      <td><div style="display:flex;align-items:center;gap:8px">
        <div style="flex:1;height:7px;background:#F4F1EC;border-radius:99px;overflow:hidden"><div style="width:${p}%;height:100%;background:${t.couleur};border-radius:99px"></div></div>
        <span class="amt" style="font-size:.76rem;color:var(--muted);min-width:34px">${p}%</span>
      </div></td>
      <td class="amt" style="font-size:.8rem">${m.toLocaleString('fr-FR')} FCFA</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTypes(){
  document.getElementById('typesGrid').innerHTML=S.types.map(t=>{
    const cnt=S.dep.filter(d=>d.type===t.nom).length;
    return`<div class="type-card">
      <div class="type-dot" style="background:${t.couleur}"></div>
      <div style="flex:1;min-width:0"><div class="type-name">${t.nom}</div><div class="type-cnt">${cnt} op.</div></div>
      ${t.systeme?`<span style="font-size:.7rem;color:var(--muted)">ğŸ”’</span>`:`<button class="btn btn-d" onclick="delType('${t.id}')" style="padding:4px 9px;font-size:.72rem">ğŸ—‘ï¸</button>`}
    </div>`;
  }).join('');
}
function pickColor(el){
  S.selColor=el.dataset.c;
  document.getElementById('tColor').value=S.selColor;
  document.querySelectorAll('[data-c]').forEach(e=>{e.style.border=e.dataset.c===S.selColor?`3px solid ${S.selColor}`:'3px solid transparent';e.style.transform=e.dataset.c===S.selColor?'scale(1.25)':'scale(1)';});
  updateTypePrev();
}
function pickColorVal(v){
  S.selColor=v; document.getElementById('tColor').value=v; updateTypePrev();
}
function updateTypePrev(){
  const c=S.selColor,n=document.getElementById('tNom').value||'Nouveau type';
  const p=document.getElementById('tPrev');
  p.style.background=c+'22';p.style.color=c;
  p.querySelector('div').style.background=c;
  p.querySelector('span').textContent=n;
}
function openModalType(){document.getElementById('tNom').value='';pickColor(document.querySelector('[data-c="#064E3B"]'));openModal('mType');}
async function saveType(){
  const nom=document.getElementById('tNom').value.trim();
  const couleur=document.getElementById('tColor').value;
  if(!nom){toast('Nom requis','warn');return;}
  if(S.types.find(t=>t.nom.toLowerCase()===nom.toLowerCase())){toast('Ce type existe dÃ©jÃ ','warn');return;}
  const nt={id:uid(),nom,couleur,systeme:false};
  try{
    let saved=nt;
    if(DB_OK){const r=await dbPost('types_depenses',nt).catch(()=>null);if(r&&r[0])saved=r[0];}
    S.types.push(saved);
    addLog('NOUVEAU TYPE',nom);
    lsSave();closeModal('mType');renderTypes();toast(`"${nom}" crÃ©Ã© âœ“`);
  }catch(e){toast('Erreur','err');}
}
async function delType(id){
  const t=S.types.find(x=>x.id===id); if(!t)return;
  if(S.dep.some(d=>d.type===t.nom)){toast(`"${t.nom}" est utilisÃ© par des dÃ©penses`,'warn');return;}
  if(!confirm(`Supprimer "${t.nom}" ?`))return;
  try{
    if(DB_OK) await dbDel('types_depenses',id).catch(()=>{});
    S.types=S.types.filter(x=>x.id!==id);
    addLog('SUPPRESSION TYPE',t.nom);
    lsSave();renderTypes();toast(`"${t.nom}" supprimÃ©`);
  }catch(e){toast('Erreur','err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILISATEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUsers(){
  document.getElementById('usersGrid').innerHTML=S.users.map(u=>{
    const rs=ROLE_STYLE[u.role]||{};
    return`<div class="ucard" style="opacity:${u.actif!==false?1:.55}">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
        <div class="ucard-av" style="background:${rs.bg};color:${rs.c}">${(u.nom||u.login)[0].toUpperCase()}</div>
        <div><div class="ucard-name">${u.nom||u.login}</div><div class="ucard-login">@${u.login}</div></div>
      </div>
      <div style="display:flex;gap:5px;margin-bottom:8px">
        <span class="badge" style="background:${rs.bg};color:${rs.c}">${u.role}</span>
        ${u.actif!==false?'<span class="badge bv">Actif</span>':'<span class="badge bn">Inactif</span>'}
      </div>
      <div style="font-size:.7rem;color:var(--muted);margin-bottom:10px;line-height:1.7">
        ${u.email?`ğŸ“§ ${u.email}<br>`:''}
        ${u.derniere_connexion?'ğŸ• '+fdt(u.derniere_connexion):'Jamais connectÃ©'}
      </div>
      <div style="display:flex;gap:5px">
        ${u.actif!==false
          ?`<button class="btn btn-d" onclick="toggleUser('${u.id}',false)" style="font-size:.72rem;padding:5px 9px">ğŸš« DÃ©sactiver</button>`
          :`<button class="btn btn-p" onclick="toggleUser('${u.id}',true)" style="font-size:.72rem;padding:5px 9px">âœ… Activer</button>`}
        ${u.login!==S.user?`<button class="btn btn-s" onclick="delUser('${u.id}')" style="font-size:.72rem;padding:5px 9px">ğŸ—‘ï¸</button>`:''}
      </div>
    </div>`;
  }).join('');
}
function openModalUser(){['uLogin','uPwd','uNom','uEmail'].forEach(i=>document.getElementById(i).value='');document.getElementById('uRole').value='Saisie';openModal('mUser');}
async function saveUser(){
  const login=document.getElementById('uLogin').value.trim();
  const pwd=document.getElementById('uPwd').value;
  const nom=document.getElementById('uNom').value.trim();
  const role=document.getElementById('uRole').value;
  const email=document.getElementById('uEmail').value.trim();
  if(!login||!pwd){toast('Login et mot de passe requis','warn');return;}
  if(pwd.length<4){toast('Mot de passe trop court','warn');return;}
  if(S.users.find(u=>u.login.toLowerCase()===login.toLowerCase())){toast('Identifiant dÃ©jÃ  utilisÃ©','warn');return;}
  const nu={id:uid(),login,pwd:hp(pwd),nom,role,email,actif:true,derniere_connexion:null};
  try{
    let saved=nu;
    if(DB_OK){const r=await dbPost('utilisateurs',nu).catch(()=>null);if(r&&r[0])saved=r[0];}
    S.users.push(saved);
    addLog('CREATION USER',`${login} [${role}]`);
    lsSave();closeModal('mUser');renderUsers();toast(`@${login} crÃ©Ã© âœ“`);
  }catch(e){toast('Erreur','err');}
}
async function toggleUser(id,actif){
  const u=S.users.find(x=>x.id===id); if(!u)return;
  if(!actif&&u.login===S.user){toast('Impossible de dÃ©sactiver votre propre compte','warn');return;}
  try{
    if(DB_OK) await dbPatch('utilisateurs',id,{actif}).catch(()=>{});
    u.actif=actif;
    addLog(actif?'ACTIVATION':'DESACTIVATION',u.login);
    lsSave();renderUsers();toast(`@${u.login} ${actif?'activÃ©':'dÃ©sactivÃ©'}`);
  }catch(e){toast('Erreur','err');}
}
async function delUser(id){
  const u=S.users.find(x=>x.id===id); if(!u||u.login===S.user)return;
  if(!confirm(`Supprimer @${u.login} ?`))return;
  try{
    if(DB_OK) await dbDel('utilisateurs',id).catch(()=>{});
    S.users=S.users.filter(x=>x.id!==id);
    addLog('SUPPRESSION USER',u.login);
    lsSave();renderUsers();toast(`@${u.login} supprimÃ©`);
  }catch(e){toast('Erreur','err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOURNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOG_C={CONNEXION:'#10B981',DECONNEXION:'#9CA3AF',SAISIE:'#3B82F6',MODIFICATION:'#F59E0B',SUPPRESSION:'#EF4444','CREATION USER':'#8B5CF6',ACTIVATION:'#10B981',DESACTIVATION:'#EF4444','NOUVEAU TYPE':'#14B8A6',PARAMS:'#6366F1'};
function renderJournal(){
  document.getElementById('logList').innerHTML=S.logs.length===0
    ?'<div style="text-align:center;padding:40px;color:var(--muted)">Journal vide</div>'
    :S.logs.slice(0,100).map(j=>`<div class="log-item">
      <div class="log-dot" style="background:${LOG_C[j.action]||'#9CA3AF'}"></div>
      <div class="log-txt">
        <div class="log-action">${j.action} <span style="color:var(--muted);font-weight:400">â€” ${j.utilisateur||j.user||'?'}</span> <span class="badge bg" style="font-size:.63rem">${j.role||''}</span></div>
        <div class="log-detail">${j.detail||''}</div>
      </div>
      <div class="log-ts">${j.ts?fdt(j.ts):''}</div>
    </div>`).join('');
}
async function clearLog(){if(!confirm('Vider le journal ?'))return;S.logs=[];lsSave();renderJournal();toast('Journal vidÃ©');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARAMÃˆTRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadParams(){
  const p=S.params;
  document.getElementById('pNom').value=p.nom||'Pharmacie Rahmane';
  document.getElementById('pVille').value=p.ville||'ThiÃ¨s, SÃ©nÃ©gal';
  document.getElementById('pEmail').value=p.email||'rahmanepharmacie@gmail.com';
  document.getElementById('pTel').value=p.tel||'';
  document.getElementById('pProp').value=p.prop||'Dr. Khady Diene';
  document.getElementById('pLic').value=p.lic||'';
}
function saveParams(){
  S.params={nom:document.getElementById('pNom').value,ville:document.getElementById('pVille').value,email:document.getElementById('pEmail').value,tel:document.getElementById('pTel').value,prop:document.getElementById('pProp').value,lic:document.getElementById('pLic').value};
  lsSave();addLog('PARAMS','Informations pharmacie mises Ã  jour');
  toast('ParamÃ¨tres enregistrÃ©s âœ“');
}
function changePwd(){
  const old=document.getElementById('pwdOld').value;
  const nw=document.getElementById('pwdNew').value;
  const cf=document.getElementById('pwdConf').value;
  if(!old||!nw||!cf){toast('Tous les champs requis','warn');return;}
  const u=S.users.find(x=>x.login===S.user);
  if(!u||u.pwd!==hp(old)){toast('Ancien mot de passe incorrect','err');return;}
  if(nw.length<4){toast('Nouveau mot de passe trop court','warn');return;}
  if(nw!==cf){toast('Les mots de passe ne correspondent pas','err');return;}
  u.pwd=hp(nw);
  if(DB_OK) dbPatch('utilisateurs',u.id,{pwd:hp(nw)}).catch(()=>{});
  lsSave();addLog('CHANGEMENT MDP',S.user);
  toast('Mot de passe modifiÃ© âœ“');
  ['pwdOld','pwdNew','pwdConf'].forEach(id=>document.getElementById(id).value='');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyLogo(){
  const l=S.logo;
  const li=document.getElementById('lLogoImg'); const le=document.getElementById('lLogoEmoji');
  const si=document.getElementById('sbLogoImg'); const se=document.getElementById('sbLogoEmoji');
  const del=document.getElementById('btnDelLogo');
  if(l){
    li.src=l;li.style.display='block';le.style.display='none';
    si.src=l;si.style.display='block';se.style.display='none';
    document.getElementById('logoPrev').src=l;document.getElementById('logoPrev').style.display='block';
    document.getElementById('logoPlaceholder').style.display='none';
    if(del)del.style.display='inline-flex';
  } else {
    li.style.display='none';le.style.display='block';
    si.style.display='none';se.style.display='block';
    document.getElementById('logoPrev').style.display='none';
    document.getElementById('logoPlaceholder').style.display='block';
    if(del)del.style.display='none';
  }
}
function loadLogo(e){
  const f=e.target.files[0]; if(!f)return;
  if(f.size>2*1024*1024){toast('Max 2 MB','warn');return;}
  const r=new FileReader();
  r.onload=ev=>{S.logo=ev.target.result;lsSave();applyLogo();toast('Logo mis Ã  jour âœ“');};
  r.readAsDataURL(f);
}
function delLogo(){if(!confirm('Supprimer le logo ?'))return;S.logo=null;lsSave();applyLogo();toast('Logo supprimÃ©');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PDF / EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPDF(){openModal('mPDF');}
function printPage(id){
  closeModal('mPDF'); go(id);
  setTimeout(()=>{
    const hdr=document.createElement('div');
    hdr.id='_pdfh';
    hdr.style.cssText='display:flex;align-items:center;gap:14px;padding:14px 20px;background:linear-gradient(135deg,#064E3B,#047857);border-radius:10px;margin-bottom:16px;print-color-adjust:exact;-webkit-print-color-adjust:exact';
    const lg=S.logo?`<img src="${S.logo}" style="width:48px;height:48px;border-radius:9px;object-fit:contain;background:white;padding:3px">`:`<span style="font-size:1.8rem">â˜ªï¸</span>`;
    hdr.innerHTML=`${lg}<div><div style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:white">${S.params.nom||'Pharmacie Rahmane'}</div><div style="font-size:.72rem;color:rgba(167,243,208,.8);margin-top:2px">${S.params.ville||'ThiÃ¨s, SÃ©nÃ©gal'} Â· ${new Date().toLocaleDateString('fr-FR')}</div></div>`;
    const c=document.getElementById('mainContent')||document.querySelector('.content');
    c.insertBefore(hdr,c.firstChild);
    addLog('IMPRESSION PDF',PAGES[id]?.t||id);
    window.print();
    setTimeout(()=>hdr.remove(),500);
  },300);
}
function genMonthly(){
  closeModal('mPDF');
  const mois=prompt('Mois (1-12) :',new Date().getMonth()+1); if(!mois)return;
  const annee=prompt('AnnÃ©e :',new Date().getFullYear()); if(!annee)return;
  const m=parseInt(mois),y=parseInt(annee);
  const pStr=new Date(y,m-1,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  const dep=S.dep.filter(d=>{if(!d.date)return false;const dd=new Date(d.date);return dd.getMonth()===m-1&&dd.getFullYear()===y;});
  const tot=dep.reduce((s,d)=>s+Number(d.montant),0);
  const win=window.open('','_blank','width=900,height=700');
  const lg=S.logo?`<img src="${S.logo}" style="width:72px;height:72px;border-radius:12px;object-fit:contain;background:white;padding:4px">`:`<span style="font-size:2.8rem">â˜ªï¸</span>`;
  win.document.write(`<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8">
  <title>Rapport ${pStr} Â· ${S.params.nom||'Pharmacie Rahmane'}</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@400;600&family=DM+Mono&display=swap" rel="stylesheet">
  <style>body{font-family:'DM Sans',sans-serif;margin:0;padding:28px;color:#1C1917;}@media print{body{padding:12px;}}</style></head><body>
  <div style="display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#064E3B,#047857);padding:24px 28px;border-radius:14px;margin-bottom:24px;print-color-adjust:exact;-webkit-print-color-adjust:exact">
    <div style="display:flex;align-items:center;gap:16px">${lg}<div><div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:#fff">${S.params.nom||'Pharmacie Rahmane'}</div><div style="color:rgba(167,243,208,.75);font-size:.8rem;margin-top:3px">${S.params.ville||'ThiÃ¨s'}</div></div></div>
    <div style="text-align:right;color:rgba(255,255,255,.75);font-size:.78rem"><div style="font-size:1rem;font-weight:700;color:#fff;margin-bottom:3px">RAPPORT MENSUEL</div><div>${pStr}</div><div>GÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')}</div><div>Par : ${S.users.find(x=>x.login===S.user)?.nom||S.user}</div></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px">
    <div style="border:1px solid #E5E0D8;border-radius:9px;padding:14px;border-top:3px solid #064E3B"><div style="font-size:.62rem;font-weight:700;color:#78716C;text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px">Total du mois</div><div style="font-family:'DM Mono',monospace;font-size:1.4rem;font-weight:500;color:#064E3B">${tot.toLocaleString('fr-FR')} FCFA</div></div>
    <div style="border:1px solid #E5E0D8;border-radius:9px;padding:14px;border-top:3px solid #D97706"><div style="font-size:.62rem;font-weight:700;color:#78716C;text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px">OpÃ©rations</div><div style="font-family:'DM Mono',monospace;font-size:1.4rem;font-weight:500;color:#D97706">${dep.length}</div></div>
    <div style="border:1px solid #E5E0D8;border-radius:9px;padding:14px;border-top:3px solid #2563EB"><div style="font-size:.62rem;font-weight:700;color:#78716C;text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px">Moyenne</div><div style="font-family:'DM Mono',monospace;font-size:1.4rem;font-weight:500;color:#1E40AF">${dep.length?Math.round(tot/dep.length).toLocaleString('fr-FR'):0} FCFA</div></div>
  </div>
  ${dep.length===0?`<div style="text-align:center;padding:40px;color:#78716C;border:1px dashed #E5E0D8;border-radius:9px">Aucune opÃ©ration</div>`:`
  <table style="width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px">
    <thead><tr style="background:#F0FDF4">
      ${['NÂ°','Date','Type','Description','BÃ©nÃ©ficiaire','Montant FCFA','Statut'].map(h=>`<th style="padding:9px 11px;border:1px solid #E5E0D8;font-size:.6rem;font-weight:700;color:#78716C;text-transform:uppercase;text-align:left">${h}</th>`).join('')}
    </thead><tbody>
    ${dep.map((d,i)=>`<tr style="background:${i%2?'#fff':'#F9F7F4'}">
      <td style="padding:7px 11px;border:1px solid #E5E0D8;text-align:center">${i+1}</td>
      <td style="padding:7px 11px;border:1px solid #E5E0D8">${fd(d.date)}</td>
      <td style="padding:7px 11px;border:1px solid #E5E0D8"><span style="background:${tc(d.type)}18;color:${tc(d.type)};padding:1px 7px;border-radius:99px;font-weight:600;font-size:.65rem">${d.type}</span></td>
      <td style="padding:7px 11px;border:1px solid #E5E0D8">${d.libelle}</td>
      <td style="padding:7px 11px;border:1px solid #E5E0D8">${d.benef||'â€“'}</td>
      <td style="padding:7px 11px;border:1px solid #E5E0D8;text-align:right;font-family:'DM Mono',monospace;font-weight:600">${Number(d.montant).toLocaleString('fr-FR')}</td>
      <td style="padding:7px 11px;border:1px solid #E5E0D8">${d.statut}</td>
    </tr>`).join('')}
    <tr style="background:#064E3B;print-color-adjust:exact;-webkit-print-color-adjust:exact">
      <td colspan="5" style="padding:10px 11px;color:#fff;font-weight:700;font-size:.85rem;border:1px solid #064E3B">TOTAL GÃ‰NÃ‰RAL</td>
      <td style="padding:10px 11px;color:#F59E0B;font-weight:700;font-family:'DM Mono',monospace;font-size:.85rem;text-align:right;border:1px solid #064E3B">${tot.toLocaleString('fr-FR')}</td>
      <td style="border:1px solid #064E3B"></td>
    </tr></tbody></table>`}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:28px;margin-top:40px;border-top:1px solid #E5E0D8;padding-top:20px">
    <div><div style="font-size:.7rem;color:#78716C;margin-bottom:32px;font-weight:600">SIGNATURE DU RESPONSABLE</div><div style="border-top:2px solid #1C1917;padding-top:7px;font-size:.78rem;color:#78716C">${S.params.prop||'Dr. Khady Diene'}<br>${S.params.nom||'Pharmacie Rahmane'}</div></div>
    <div><div style="font-size:.7rem;color:#78716C;margin-bottom:32px;font-weight:600">VISA DU COMPTABLE</div><div style="border-top:2px solid #1C1917;padding-top:7px;font-size:.78rem;color:#78716C">Dado Ba<br>Comptable</div></div>
  </div>
  <div style="text-align:center;margin-top:28px;padding:10px;background:#F4F1EC;border-radius:7px;font-size:.68rem;color:#78716C">${S.params.nom||'Pharmacie Rahmane'} Â· ${S.params.ville||'ThiÃ¨s'} Â· ${S.params.email||''}</div>
  <script>window.onload=()=>setTimeout(()=>window.print(),400);<\/script>
  </body></html>`);
  win.document.close();
  addLog('RAPPORT MENSUEL',pStr+' â€” '+dep.length+' ops â€” '+tot.toLocaleString('fr-FR')+' FCFA');
}

function doCSV(){
  const h=['NÂ°','Date','Type','Description','BÃ©nÃ©ficiaire','Mode','RÃ©fÃ©rence','Montant FCFA','Statut','Observations'];
  const rows=S.dep.map((d,i)=>[i+1,fd(d.date),d.type,d.libelle,d.benef||'',d.mode||'',d.ref||'',d.montant,d.statut,d.obs||'']);
  const csv=[h,...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'}));
  a.download=`Registre_PharmaRahmane_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  addLog('EXPORT CSV',S.dep.length+' lignes');
  toast(`${S.dep.length} lignes exportÃ©es âœ“`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-bg').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DÃ‰CONNEXION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function logout(){
  if(!confirm('Se dÃ©connecter ?'))return;
  addLog('DECONNEXION',S.user); lsSave();
  S.user=null; S.role=null; S.attempts=0;
  document.getElementById('app').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  ['loginIn','pwdIn'].forEach(id=>{const el=document.getElementById(id);el.value='';el.disabled=false;});
  const btn=document.getElementById('lBtn');btn.disabled=false;btn.textContent='Se connecter â†’';
  document.getElementById('lErr').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refresh(){renderDash();renderReg();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DÃ‰MARRAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
boot();
</script>
</body>
</html>
